<link rel="stylesheet" type="text/css" href="c3.css">
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

<body>
<script src="jquery-1.9.1.js"></script>
<script src="d3.v3.min.js" charset="utf-8"></script>
<script src="c3.min.js" charset="utf-8"></script>

<script type="text/javascript">
  // The function below is derived from <https://github.com/cowboy/jquery-bbq/blob/master/jquery.ba-bbq.js#L444>, reused under GPL. Copyright (c) 2010 "Cowboy" Ben Alman.
  (function(h){h.deparam=function(i,j){var d={},k={"true":!0,"false":!1,"null":null};h.each(i.replace(/\+/g," ").split("&"),function(i,l){var m;var a=l.split("="),c=decodeURIComponent(a[0]),g=d,f=0,b=c.split("]["),e=b.length-1;/\[/.test(b[0])&&/\]$/.test(b[e])?(b[e]=b[e].replace(/\]$/,""),b=b.shift().split("[").concat(b),e=b.length-1):e=0;if(2===a.length)if(a=decodeURIComponent(a[1]),j&&(a=a&&!isNaN(a)?+a:"undefined"===a?void 0:void 0!==k[a]?k[a]:a),e)for(;f<=e;f++)c=""===b[f]?g.length:b[f],m=g[c]=
  f<e?g[c]||(b[f+1]&&isNaN(b[f+1])?{}:[]):a,g=m;else h.isArray(d[c])?d[c].push(a):d[c]=void 0!==d[c]?[d[c],a]:a;else c&&(d[c]=j?void 0:"")});return d}})(jQuery);

  $(function(){

    function convertCounts(counts) {
      var nums = {};
      $.each(counts, function(days, value) {
        nums[days] = value[0].userdailycontribs.timeFrameEdits;
      });
      var ret = [];
      var last = 0;
      Object.keys(nums).sort(function(a,b){return a-b}).forEach(function(x){
        ret.push(nums[x] - last);
        last = nums[x];
      });
      return ret.reverse();
    }

    function genDates(last, days, n) {
      var ret = [];
      n--;
      while ( n >= 0 ) {
        ret.push(new Date(last.getFullYear(), last.getMonth(), last.getDate() - days * n).toISOString().substring(0, 10));
        n--;
      }
      return ret;
    }

    function datapoints(site, user, days, num, callback) {
      var ret = {};
      var s = 0;
      var gets = [];
      var qs = [];
      while ( s < days * num ) {
        s += days;
        qs.push(s);
      }
      qs.forEach(function(d){
        gets.push($.getJSON(
          site + '?format=json&action=userdailycontribs&user='+ user +'&daysago='+ d +'&callback=?',
          function(data, textStatus, jqXHR) {
            if ( data.userdailycontribs.id != 0 ) {
              ret[d] = [data, textStatus, jqXHR];
            }
          }
        ));
      });
      $.when.apply($, gets).done(function() {
        callback(ret);
      }).fail(function(){ alert("fail!" + JSON.stringify(ret)); });
    }

    var params = $.deparam(location.search.substr(1));
    var user = params['user'];
    var days = parseInt(params['days']) || 30;
    var num  = parseInt(params['n'])    || 20;
    var sites = {
      commons: 'http://commons.wikimedia.org/w/api.php',
      meta: 'http://meta.wikimedia.org/w/api.php',
      wikidata: 'http://www.wikidata.org/w/api.php',
      mw: 'http://www.mediawiki.org/w/api.php',
      enwiki: 'http://en.wikipedia.org/w/api.php',
      jawiki: 'http://ja.wikipedia.org/w/api.php',
      jawikt: 'http://ja.wiktionary.org/w/api.php',
      enwikt: 'http://en.wiktionary.org/w/api.php',
    };
    var dates = genDates(new Date(), days, num);
    dates.unshift('date');
    var dummies = [];
    $.each(sites, function(name, api){
      dummies.push([name].concat(Array.apply(null, new Array(num)).map(Number.prototype.valueOf, 0)));
    });
    var chart = c3.generate({
      bindto: '#chart',
      
      data: {
        x: 'date',
        columns: [dates].concat(dummies),
        type: 'bar',
        order: 'asc',
      },
      axis: {
        x: {
          type: 'timeseries'
        },
        y: {
          label: 'number of edits'
        }
      },
      grid: {
        y: { show: true }
      }
    });

    var names = [];
    $.each(sites, function(name, api){
      datapoints(api, user, days, num, function(countData){
        chart.load({
          columns: [
            dates,
            [name].concat(convertCounts(countData))
          ]
        });
        names.push(name);
        chart.groups([names]);
      });
    });
  });

</script>

<div id="chart" style="height: 90%;"></div>

<p>

<a href="https://github.com/whym/gdc"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
<em>Powered by <a href="http://c3js.org/">C3.js</a>, <a href="http://d3js.org/">D3.js</a> and <a href="https://jquery.com/">jQuery</a>.</em>
<em>This chart is released under <a href="http://creativecommons.org/publicdomain/zero/1.0">CC0</a>.</em>
</p>

</body>
