<link rel="stylesheet" type="text/css" href="c3.css">
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

<body>
<script src="jquery-1.9.1.js"></script>
<script src="d3.v3.min.js" charset="utf-8"></script>
<script src="c3.min.js" charset="utf-8"></script>

<script type="text/javascript">
  $(function(){
    // var chart2 = c3.generate({
    //   data: {
    //     bindto: '#chart',
    //     x: 'x',
    //     columns: [
    //       ['x', '2013-01-01', '2013-01-02', '2013-01-03', '2013-01-04', '2013-01-05', '2013-01-06'],
    //       ['sample', 0, 0, 0, 0, 0, 0]
    //     ]
    //   },
    //   axis : {
    //     x : {
    //       type : 'timeseries'
    //     }
    //   }
    // });
    // chart2.load({
    //   columns: [
    //     ['x', '2013-01-01', '2013-01-02', '2013-01-03', '2013-01-04', '2013-01-05', '2013-01-06'],
    //     ['sample']
    //   ]
    // });

    function convertCounts(counts) {
      var nums = {};
      $.each(counts, function(days, value) {
        nums[days] = value[0].userdailycontribs.timeFrameEdits;
      });
      var ret = [];
      var last = 0;
      Object.keys(nums).sort(function(a,b){return a-b}).forEach(function(x){
        ret.push(nums[x] - last);
        last = nums[x];
      });
      return ret.reverse();
    }

    function genDates(last, days, n) {
      var ret = [];
      n--;
      while ( n >= 0 ) {
        ret.push(new Date(last.getFullYear(), last.getMonth(), last.getDate() - days * n).toISOString().substring(0, 10));
        n--;
      }
      return ret;
    }

    function datapoints(site, user, days, num, callback) {
      var ret = {};
      var s = 0;
      var gets = [];
      var qs = [];
      while ( s < days * num ) {
        s += days;
        qs.push(s);
      }
      qs.forEach(function(d){
        gets.push($.getJSON(
          site + '?format=json&action=userdailycontribs&user='+ user +'&daysago='+ d +'&callback=?',
          function(data, textStatus, jqXHR) {
            ret[d] = [data, textStatus, jqXHR];
          }
        ));
      });
      $.when.apply($, gets).then(function() {
        callback(ret);
      }, function(){ alert("fail!" + JSON.stringify(ret)); });
    }
    
    var days = 7;
    var num = 36;
    var sites = {
      commons: 'http://commons.wikimedia.org/w/api.php',
      meta: 'http://meta.wikimedia.org/w/api.php',
      wikidata: 'http://www.wikidata.org/w/api.php',
      mw: 'http://www.mediawiki.org/w/api.php',
      //enwiki: 'http://en.wikipedia.org/w/api.php',
    };
    var dates = genDates(new Date(), days, num);
    dates.unshift('date');
    var dummies = [];
    $.each(sites, function(name, api){
      dummies.push([name].concat(Array.apply(null, new Array(num)).map(Number.prototype.valueOf, 0)));
    });
    var chart = c3.generate({
      bindto: '#chart',
      
      data: {
        x: 'date',
        columns: [dates].concat(dummies),
        type: 'bar',
        order: 'asc',
      },
      axis: {
        x: {
          type: 'timeseries'
        },
        y: {
          label: 'number of edits'
        }
      },
      grid: {
        y: { show: true }
      }
    });

    var names = [];
    $.each(sites, function(name, api){
      datapoints(api, 'Whym', days, num, function(countData){
        chart.load({
          columns: [
            dates,
            [name].concat(convertCounts(countData))
          ]
        });
        names.push(name);
        chart.groups([names]);
      });
    });
  });

</script>

<div id="chart" style="height: 90%;"></div>
<div id="chart2" style="height: 90%;"></div>

<em>Powered by <a href="http://c3js.org/">C3.js</a>, <a href="http://d3js.org/">D3.js</a> and <a href="https://jquery.com/">jQuery</a>.</em>

</body>
